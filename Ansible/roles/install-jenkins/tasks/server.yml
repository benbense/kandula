---
- name: Install Docker prerequisites
  apt:
    name:
      - ca-certificates
      - gnupg
      - lsb-release
      - curl
    update_cache: yes
    state: present

- name: Install Docker Python
  pip:
    name:
      - docker

- name: Add GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg

- name: Setup Docker's stable repo
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"

- name: Install Docker engine
  apt:
    name: ["docker-ce", "docker-ce-cli", "containerd.io"]
    update_cache: yes

- name: Enable Docker Services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  with_items:
    - docker.service
    - containerd.service

- name: Create Docker group
  group:
    name: "{{ docker_group }}"
    state: present

- name: Add docker users
  user:
    name: "{{ item }}"
    groups: "{{ docker_group }}"
    append: yes
  with_items: "{{ docker_users }}"

- name: Pull Jenkins Docker image
  ansible.builtin.docker_image:
    name: jenkins/jenkins
    source: pull
    repository: registry.hub.docker.com

- name: Start Jenkins Container
  community.docker.docker_container:
    name: jenkins
    image: jenkins/jenkins
    state: started
    ports:
      - "8080:8080"
      - "50000:50000"
    env:
      JAVA_OPTS: "-Djenkins.install.runSetupWizard=false"
    volumes:
      - /home/ubuntu/jenkins/config:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock

- name: Install Jenkins Plugins
  shell: docker exec jenkins /bin/bash -c '/usr/local/bin/install-plugins.sh {{ item }}'
  with_items:
    [
      "build-pipeline-plugin",
      "ssh-slaves",
      "github-branch-source",
      "blueocean",
      "slack",
      "build-monitor-plugin",
    ]
  changed_when: true

- name: Restart Jenkins Container
  shell: docker restart jenkins
