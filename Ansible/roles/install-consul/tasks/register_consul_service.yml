---
- ec2_metadata_facts:
- ec2_instance_info:
    instance_ids: "{{ ansible_ec2_instance_id }}"
    region: "{{ ansible_ec2_placement_region }}"
  register: instance_info

- name: Save Instance Info
  set_fact:
    service: "{{ instance_info.instances | map(attribute='tags.service') | list | join('\n') }}"
    instance_type: "{{ instance_info.instances | map(attribute='tags.instance_type') | list | join('\n') }}"

- name: Register Jenkins Server service
  when: service == jenkins and instance_type == server
  copy:
    src: jenkins_server_service.json
    dest: /etc/consul.d/jenkins_server_service.json

- name: Register Jenkins Node service
  when: service == jenkins and instance_type == node
  copy:
    src: jenkins_node_service.json
    dest: /etc/consul.d/jenkins_node_service.json

- name: Register Bastion Host service
  when: service == bastion and instance_type == server
  copy:
    src: jenkins_bastion_service.json
    dest: /etc/consul.d/jenkins_bastion_service.json

- name: Reload Consul service
  systemd:
    name: consul.service
    state: reloaded
